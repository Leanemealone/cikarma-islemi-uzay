<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Uzayda Matematik: Seviye MacerasÄ±</title>

<link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">

<style>
body {
    margin: 0;
    overflow: hidden;
    background: #000;
    color: white;
    font-family: 'Luckiest Guy', Arial;
}

/* ðŸ”§ MOBÄ°L SELECT FIX */
select {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

canvas {
    display: block;
    background-color: #000;
    pointer-events: none; /* ðŸ”§ giriÅŸte canvas pasif */
}

.game-active canvas {
    pointer-events: auto; /* ðŸ”§ oyun baÅŸlayÄ±nca aktif */
}

#entryPanel {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(10, 10, 50, 0.95);
    padding: 30px;
    border-radius: 25px;
    text-align: center;
    border: 5px solid #FFD700;
    z-index: 1000;
    width: 320px;
}

#entryPanel h2 {
    color: #FFD700;
    margin-bottom: 20px;
    font-size: 28px;
}

select, input, button {
    padding: 12px;
    margin: 10px 0;
    border-radius: 12px;
    font-size: 18px;
    width: 100%;
    border: none;
}

select, input {
    background: #eee;
    color: #333;
}

button {
    background: #00FF00;
    cursor: pointer;
}

#leaderboard {
    margin-top: 20px;
    max-height: 180px;
    overflow-y: auto;
    font-size: 14px;
}
.score-row {
    display: flex;
    justify-content: space-between;
}
</style>
</head>

<body>

<div id="entryPanel">
    <h2>KOZMÄ°K GÄ°RÄ°Åž</h2>
    <select id="studentSelect">
        <option>YÃ¼kleniyor...</option>
    </select>
    <input type="password" id="passInput" placeholder="ÅžÄ°FRE">
    <button id="startBtn">MACERAYA BAÅžLA</button>

    <div id="leaderboard">
        <div style="text-align:center;color:#FFD700">TOP 10</div>
        <div id="scoreList">YÃ¼kleniyor...</div>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ðŸ”¥ FIREBASE */
const firebaseConfig = {
    apiKey: "AIzaSyBLNmwvxDkVk2qpwwLt-CoXFtb45N3_Mvg",
    authDomain: "uzay-cikarma-oyunu.firebaseapp.com",
    projectId: "uzay-cikarma-oyunu"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ðŸ”¥ CANVAS */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let currentUser = "";
let girisYapildi = false;

/* ðŸ”¥ Ã–ÄžRENCÄ°LER */
async function ogrenciListesiniYukle() {
    const select = document.getElementById("studentSelect");
    const snap = await getDocs(collection(db, "ogrenciler"));

    select.innerHTML = `<option value="">Ä°SMÄ°NÄ° SEÃ‡...</option>`;
    snap.forEach(docSnap => {
        const opt = document.createElement("option");
        opt.value = docSnap.id;
        opt.textContent = docSnap.data().ad;
        select.appendChild(opt);
    });
}
ogrenciListesiniYukle();

/* ðŸ”¥ GÄ°RÄ°Åž */
document.getElementById("startBtn").onclick = async () => {
    const id = studentSelect.value;
    const pass = passInput.value;
    if (!id) return alert("Ä°sim seÃ§");

    const snap = await getDoc(doc(db, "ogrenciler", id));
    if (snap.exists() && snap.data().sifre === pass) {
        currentUser = snap.data().ad;
        girisYapildi = true;

        document.body.classList.add("game-active");
        entryPanel.style.display = "none";

        oyunuSifirla();
        guncelle();
    } else {
        alert("HatalÄ± ÅŸifre");
    }
};

/* ðŸ”¥ MOBÄ°L DOKUNMA FIX */
function kontrol(x, y) {
    if (!girisYapildi) return;
    gemi.x = x - 40;
    gemi.y = y - 40;
}

window.addEventListener("touchstart", e => {
    if (!girisYapildi) return; // ðŸ”§ GÄ°RÄ°ÅžTE DOKUNMA SERBEST
    kontrol(e.touches[0].clientX, e.touches[0].clientY);
    e.preventDefault();
}, { passive:false });

window.addEventListener("touchmove", e => {
    if (!girisYapildi) return;
    kontrol(e.touches[0].clientX, e.touches[0].clientY);
    e.preventDefault();
}, { passive:false });

/* ðŸ”¥ OYUN */
let gemi = {x:0,y:0};
let skor = 0;

function ekranBoyutlandir(){
    canvas.width = innerWidth;
    canvas.height = innerHeight;
}
ekranBoyutlandir();
addEventListener("resize", ekranBoyutlandir);

function oyunuSifirla(){
    skor = 0;
    gemi.x = canvas.width/2;
    gemi.y = canvas.height-120;
}

function guncelle(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="white";
    ctx.fillText(currentUser+" | "+skor,20,40);
    ctx.fillRect(gemi.x,gemi.y,60,60);
    requestAnimationFrame(guncelle);
}

/* ðŸ”¥ LEADERBOARD */
const q = query(collection(db,"uzay_skorlar"), orderBy("skor","desc"), limit(10));
onSnapshot(q,s=>{
    scoreList.innerHTML="";
    s.forEach(d=>{
        scoreList.innerHTML+=`<div class="score-row"><span>${d.data().isim}</span><span>${d.data().skor}</span></div>`;
    });
});
</script>
</body>
</html>
