<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Uzayda Matematik</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: 'Luckiest Guy', Arial; touch-action: none; }
        canvas { display: block; background: url('https://raw.githubusercontent.com/Leanemealone/assets-images/refs/heads/main/arka%20plan%20(2).png'); background-size: cover; }
    </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// SESLER
const arkaPlanMuzigi = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
arkaPlanMuzigi.loop = true; arkaPlanMuzigi.volume = 0.2;
const crashSesi = new Audio('https://raw.githubusercontent.com/Leanemealone/cikarma-islemi-uzay/main/crash.mp3');
const alkisSesi = new Audio('https://raw.githubusercontent.com/Leanemealone/Eldeli-Toplama-Oyunu/main/clap.mp3');

function ekranBoyutlandir() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
ekranBoyutlandir();
window.addEventListener("resize", ekranBoyutlandir);

let skor = 0; let meteorHizi = 1.3; let soru = { s1: 0, s2: 0, sonuc: 0 }; 
let meteorlar = []; let gemi = { x: canvas.width / 2, y: canvas.height - 200 };
let kalanSure = 120; let oyunBitti = false;
let mesaj = ""; let mesajRengi = ""; let mesajSayac = 0;

let zamanlayici = setInterval(() => {
    if (!oyunBitti) {
        kalanSure--;
        if (kalanSure <= 0) { kalanSure = 0; oyunBitti = true; clearInterval(zamanlayici); }
    }
}, 1000);

const gemiResmi = new Image(); gemiResmi.src = 'https://raw.githubusercontent.com/Leanemealone/assets-images/refs/heads/main/uzay%20araci.png';
const meteorResmi = new Image(); meteorResmi.src = 'https://raw.githubusercontent.com/Leanemealone/assets-images/refs/heads/main/goktasi.png';

// --- GELİŞTİRİLMİŞ ÇAKIŞMA ÖNLEYİCİ SİSTEM ---
function soruUret() {
    soru.s1 = Math.floor(Math.random() * 30) + 20;
    soru.s2 = Math.floor(Math.random() * 15) + 1;
    soru.sonuc = soru.s1 - soru.s2;
    
    let tipler = [
        { v: soru.sonuc, t: "dogru" },
        { v: soru.sonuc + 5, t: "yanlis" },
        { v: soru.sonuc - 3, t: "yanlis" },
        { v: soru.sonuc + 8, t: "yanlis" }
    ];

    meteorlar = [];
    
    // 1. Önce DOĞRU meteoru yerleştir (Referans noktamız bu)
    let dogruX = Math.random() * (canvas.width - 160);
    meteorlar.push({
        deger: tipler[0].v, tip: tipler[0].t,
        x: dogruX,
        y: -250
    });

    // 2. Yanlış meteorları doğru olandan uzaklaştırarak yerleştir
    for (let i = 1; i < tipler.length; i++) {
        let adayX;
        let deneme = 0;
        let cakisma = true;

        while (cakisma && deneme < 30) {
            adayX = Math.random() * (canvas.width - 160);
            // Hem doğru meteordan hem de eklenmiş diğer meteorlardan uzak mı?
            cakisma = meteorlar.some(m => Math.abs(m.x - adayX) < 190); 
            deneme++;
        }
        
        meteorlar.push({
            deger: tipler[i].v, tip: tipler[i].t,
            x: adayX,
            y: -250 - (i * 480) // Dikey aralığı artırdık (450 -> 480)
        });
    }

    // 3. Meteorların geliş sırasını (yüksekliklerini) rastgele karıştır
    // Sadece y koordinatlarını karıştırıyoruz ki kimin önce geleceği belli olmasın
    let yKoordinatlari = meteorlar.map(m => m.y);
    yKoordinatlari.sort(() => Math.random() - 0.5);
    meteorlar.forEach((m, index) => m.y = yKoordinatlari[index]);
}

function ekraniSalla() {
    crashSesi.currentTime = 0; crashSesi.play();
    let siddet = 10; let sayac = 0;
    let sarsinti = setInterval(() => {
        canvas.style.transform = `translate(${(Math.random()*siddet*2)-siddet}px, ${(Math.random()*siddet*2)-siddet}px)`;
        if (++sayac > 10) { clearInterval(sarsinti); canvas.style.transform = `translate(0,0)`; }
    }, 30);
}

const kontrolEt = (ex, ey) => { if(!oyunBitti) { arkaPlanMuzigi.play(); gemi.x = ex-75; gemi.y = ey-75; } };
window.addEventListener("mousemove", (e) => kontrolEt(e.clientX, e.clientY));
window.addEventListener("touchstart", (e) => { kontrolEt(e.touches[0].clientX, e.touches[0].clientY); e.preventDefault(); }, {passive: false});
window.addEventListener("touchmove", (e) => { kontrolEt(e.touches[0].clientX, e.touches[0].clientY); e.preventDefault(); }, {passive: false});

function guncelle() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (oyunBitti) {
        ctx.fillStyle = "rgba(0,0,0,0.85)"; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.font = "50px 'Luckiest Guy'";
        ctx.fillText("SÜRE BİTTİ!", canvas.width / 2, canvas.height / 2 - 20);
        ctx.fillText("PUAN: " + skor, canvas.width / 2, canvas.height / 2 + 50);
        return requestAnimationFrame(guncelle);
    }

    // SORU TASARIMI
    ctx.fillStyle = "#FFD700"; ctx.strokeStyle = "black"; ctx.lineWidth = 4; ctx.font = "55px 'Luckiest Guy'"; ctx.textAlign = "right";
    let hX = canvas.width / 2 + 40;
    ctx.strokeText(soru.s1, hX, 75); ctx.fillText(soru.s1, hX, 75);
    ctx.strokeText(soru.s2, hX, 135); ctx.fillText(soru.s2, hX, 135);
    ctx.textAlign = "left"; ctx.strokeText("-", hX - 90, 135); ctx.fillText("-", hX - 90, 135);
    ctx.beginPath(); ctx.strokeStyle = "white"; ctx.lineWidth = 5; ctx.moveTo(hX-100, 150); ctx.lineTo(hX+10, 150); ctx.stroke();

    ctx.font = "22px 'Luckiest Guy'"; ctx.textAlign = "left"; ctx.fillStyle = "white";
    ctx.fillText(`Puan: ${skor}`, 20, 35);
    ctx.textAlign = "right"; ctx.fillStyle = kalanSure < 10 ? "red" : "white";
    ctx.fillText(`Sure: ${kalanSure}`, canvas.width - 20, 35);

    if (mesajSayac > 0) {
        ctx.fillStyle = mesajRengi; ctx.font = "45px 'Luckiest Guy'"; ctx.textAlign = "center";
        ctx.strokeText(mesaj, canvas.width / 2, canvas.height / 2); ctx.fillText(mesaj, canvas.width / 2, canvas.height / 2);
        mesajSayac--;
    }

    gemi.y = Math.max(200, Math.min(gemi.y, canvas.height - 150));
    gemi.x = Math.max(0, Math.min(gemi.x, canvas.width - 150));
    ctx.drawImage(gemiResmi, gemi.x, gemi.y, 150, 150);

    meteorlar.forEach((m) => {
        m.y += meteorHizi;
        ctx.drawImage(meteorResmi, m.x, m.y, 160, 160);
        ctx.fillStyle = "white"; ctx.font = "bold 35px Arial"; ctx.textAlign = "center";
        ctx.fillText(m.deger, m.x + 80, m.y + 95);

        let t = 45; 
        if (gemi.x + t < m.x + 160 - t && gemi.x + 150 - t > m.x + t && gemi.y + t < m.y + 160 - t && gemi.y + 150 - t > m.y + t) {
            if (m.tip === "dogru") {
                alkisSesi.currentTime = 0; alkisSesi.play();
                skor += 10; kalanSure += 2; meteorHizi += 0.05;
                mesaj = "Harika! +2 sn"; mesajRengi = "#00FF00"; mesajSayac = 50; soruUret();
            } else {
                ekraniSalla(); skor = Math.max(0, skor - 10);
                mesaj = "Dikkat! -10"; mesajRengi = "red"; mesajSayac = 50;
                gemi.x = canvas.width / 2 - 75; gemi.y = canvas.height - 200;
                meteorHizi = 1.3; soruUret();
            }
        }
        // Meteor ekranın altına ulaşınca (Hata payı bırakmamak için soruUret'i tekrar çağırmıyoruz, sadece konumu sıfırlıyoruz)
        if (m.y > canvas.height) { 
            m.y = -200; 
            // Yeniden doğarken de çakışma kontrolü
            let yeniX;
            let deneme = 0;
            let cakisma = true;
            while(cakisma && deneme < 20){
                yeniX = Math.random() * (canvas.width - 160);
                cakisma = meteorlar.some(diger => diger !== m && Math.abs(diger.x - yeniX) < 180);
                deneme++;
            }
            m.x = yeniX;
        }
    });
    requestAnimationFrame(guncelle);
}
soruUret(); guncelle();
</script>
</body>
</html>
